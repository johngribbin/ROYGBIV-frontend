<script lang="ts">
  import Lnmessage from 'lnmessage'
  import { parseNodeAddress } from '../utils.js'
  import Header from '../components/Header.svelte'
  import Steps from '../components/Steps.svelte'
  import type { Info, Invoice, Member, Prism } from '../types.js'
  import { fade } from 'svelte/transition'
  import Qr from '../components/QR.svelte'
  import close from '../icons/close.js'
  import Button from '../components/Button.svelte'
  import Icon from '../components/Icon/Icon.svelte'
  import prism from '../icons/prism.js'
  import Triangle from '../components/Triangle.svelte'

  let ln: Lnmessage
  let connectionStatus$: Lnmessage['connectionStatus$']

  $: if (ln) {
    connectionStatus$ = ln.connectionStatus$
  }

  $: {
    if ($connectionStatus$ === 'connected') {
      modalOpen = null
    }
  }

  let address = '035e12a449b5d08b97deed279cff0e788a71a51ff9e72f9e6a0a024eed1d073442@localhost:7272'
  let rune = '5R_2elcqipJhcOPG49NmlxYrAqz_3L44KKoCLfV-XaU9MA=='
  let bolt12 = ''
  let info: Info

  let modalOpen: 'connect' | 'qr' | null = null
  let connecting = false

  async function connect() {
    const { publicKey, ip, port } = parseNodeAddress(address)

    // https://github.com/aaronbarnardsound/lnmessage#initialisation
    ln = new Lnmessage({
      // The public key of the node you would like to connect to
      remoteNodePublicKey: publicKey,
      // WebSocket proxy endpoint to connect through if running in prod
      // wsProxy: 'wss://<WEBSOCKET_PROXY>',
      // The IP address of the node
      ip,
      // The port of the node, defaults to 9735
      port,
      // connect directly to a node without TLS
      wsProtocol: 'ws:',
      logger: {
        info: console.log,
        error: console.error,
        warn: console.warn
      }
    })

    // initiate the connection to the remote node
    connecting = true
    await ln.connect()
    connecting = false
    modalOpen = null

    const infoResult = await request('getinfo')
    info = infoResult as Info
  }

  async function request(method: string, params?: unknown): Promise<unknown> {
    try {
      const result = await ln.commando({
        method,
        params,
        rune
      })

      return result
    } catch (error) {
      const { message } = error as { message: string }
      console.log(message)
    }
  }

  async function createPrism(prism: Prism) {
    try {
      // @TODO create bolt12 using the prism details
      const result = (await request('offer', {
        label: prism.label,
        amount: 'any',
        description: 'PRISM'
      })) as {
        bolt12: string
      }

      console.log({ result })
      bolt12 = result.bolt12
      modalOpen = 'qr'
      // const result = await request('createprism', prism)
      // bolt12 = (result as { bolt12: string }).bolt12
    } catch (error) {
      console.log(error)
    }
  }

  let lastPayIndex = 0

  async function handleFinish(e) {
    const { label, members } = e.detail
    createPrism({ label, members })

    const { invoices } = (await request('listinvoices', [])) as { invoices: Invoice[] }
    let lastInvoice = invoices.reverse()[0]

    if (lastInvoice && !lastInvoice.pay_index) {
      lastInvoice = invoices.reverse()[1]
    }

    const invoice = (await request('waitanyinvoice', [lastInvoice?.pay_index])) as Invoice

    console.log({ invoice })

    const { bolt12, amount_received_msat } = invoice

    if (bolt12 && bolt12 === bolt12 && amount_received_msat) {
      const totalAmount = members.reduce(
        (total: number, member: Member) => (total += member.split),
        0
      )

      await Promise.all(
        members.map(async (member: Member) => {
          const { name, destination, split } = member
          console.log({ amount_received_msat })
          const amountMsat = (amount_received_msat as string).replace('msat', '')
          const amount = (split / totalAmount) * Number(amountMsat)

          console.log('keysending:', { destination, name, amount })

          const result = await request('keysend', {
            destination,
            amount_msat: Math.round(amount).toString()
          })
          console.log('keysend result:', result)
        })
      )
    }
  }
</script>

<svelte:head>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap"
    rel="stylesheet"
  />
</svelte:head>
<main class="w-screen h-screen flex flex-col items-center justify-center relative">
  <Header {info} />

  {#if !info}
    <div class="mb-8 flex justify-center">
      <video src="triangle.mp4" poster="triangle.jpg" autoplay loop class="w-2/3"> ROYGBIV </video>
    </div>
  {/if}

  <!-- Button to open connect modal -->
  {#if $connectionStatus$ !== 'connected' && !modalOpen}
    <div class="flex flex-col items-center justify-center bg-black">
      <Button on:click={() => (modalOpen = 'connect')} icon="ArrowUpCircle">Connect</Button>

      <p class="max-w-md mt-8 text-center">
        ROYGBIV creates lightning prisms, which are special BOLT12 offers. Any payments received to
        these offers will split out to multiple recipients. Connect your Core Lightning node to get
        started.
      </p>
    </div>
  {/if}

  <!-- Prism Steps -->
  {#if $connectionStatus$ === 'connected'}
    <Steps on:finish={handleFinish} />
  {/if}
</main>

<!-- Connect Modal -->
{#if modalOpen === 'connect'}
  <div
    transition:fade
    class="w-full h-full bg-black absolute top-0 bg-black/30 flex flex-col items-center justify-center z-10"
  >
    <!-- svelte-ignore a11y-click-events-have-key-events -->
    <div
      class="p-4 cursor-pointer absolute top-4 right-4 text-white"
      on:click={() => (modalOpen = null)}
    >
      <div class="w-6 h-6">
        <Icon icon="Cross" />
      </div>
    </div>
    <div class="w-1/2 max-w-lg border-2 p-6 rounded relative bg-black">
      <h1 class="text-lg">Connect your Node</h1>
      <!-- Address -->
      <div class="mt-4 w-full text-sm">
        <label class="font-medium mb-1 block" for="address">Address</label>
        <textarea
          id="address"
          class="border w-full p-2 rounded"
          rows="3"
          bind:value={address}
          placeholder="033f4bbfcd67bd0fc858499929a3255d063999ee23f4c5e12b8b1089e132b3e408@localhost:7272"
        />
      </div>
      <!-- Rune -->
      <div class="w-full mt-4 text-sm">
        <label class="font-medium mb-1 block" for="rune">Rune</label>
        <textarea
          id="rune"
          class="border w-full p-2 rounded"
          rows="2"
          bind:value={rune}
          placeholder="O2osJxV-6lGUgAf-0NllduniYbq1Zkn-45trtbx4qAE9MA=="
        />
      </div>
      <!-- Connect Button -->
      <div class="flex items-center justify-between w-full mt-4">
        <Button on:click={connect} disabled={!address}>
          {$connectionStatus$ === 'connecting' ? '...' : 'Connect'}
        </Button>
      </div>
    </div>
  </div>
{/if}

<!-- QR Modal -->
{#if modalOpen === 'qr'}
  <div
    transition:fade
    class="flex w-full h-full top-0 absolute backdrop-blur-sm bg-black/30 flex flex-col items-center justify-center z-10"
  >
    <button
      class="w-8 cursor-pointer absolute top-4 right-4 z-[99]"
      on:click={() => (modalOpen = null)}
    >
      {@html close}
    </button>

    <Triangle />
    <div class="fixed top-0 left-0 w-full h-full flex flex-col justify-center items-center">
      <Qr value={bolt12} />
    </div>
  </div>
{/if}

<style>
  h2 {
    @apply font-bold text-lg;
  }
</style>
